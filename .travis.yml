language: python

matrix:
  include:
    - os: linux
      dist: trusty
      sudo: required
      env: UPDATE_REPOSITORY="true"
    - os: linux
      dist: trusty
      sudo: required
      env: UPDATE_REPOSITORY="add-apt-repository -y ppa:octave/stable"
    - os: osx
      env: BUILD_MATLAB=0
    - os: osx
      env: BUILD_MATLAB=1

before_install:
  - sudo git clone --depth 1 https://github.com/hpdata/gdutil /usr/local/gdutil && \
    sudo pip3 install -r /usr/local/gdutil/requirements.txt && \
    sudo ln -s -f /usr/local/gdutil/gd_get_pub.py /usr/local/bin/gd-get-pub
  - 'if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
        sudo $UPDATE_REPOSITORY;
        sudo apt-get update -q;
        sudo apt-get install -y octave bsdtar liboctave-dev mpich2 libmpich2-dev;
        gd-get-pub $ACCESSKEY_LINUX | sudo bsdtar zxf - -C /usr/local --strip-components 2;
        sudo ln -s -f /usr/local/MATLAB/R*/bin/mex /usr/local/bin;
      fi'
  # For Mac, install Octave and link g++-7 to g++-mp
  - 'if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
        brew tap homebrew/science;
        brew update;
        brew install --without-java octave;
        brew install mpich2;
        gd-get-pub $ACCESSKEY_OSX | sudo bsdtar zxf - -C /Applications --strip-components 1;
        sudo ln -s -f /Applications/MATLAB_R*/bin/mex /usr/local/bin;
        ln -s -f /usr/local/bin/gcc-7 /usr/local/bin/gcc-mp;
        ln -s -f /usr/local/bin/g++-7 /usr/local/bin/g++-mp;
        ls -l /usr/local/bin/gcc-* /usr/local/bin/g++-*;
     fi'

script:
  - '[[ "$BUILD_MATLAB" == "1" ]] || octave --eval "build_m2c -force"'
  - '[[ "$BUILD_MATLAB" == "0" ]] || ls -l /usr/local/bin/mex && octave --eval "build_m2c -force -matlab"'
